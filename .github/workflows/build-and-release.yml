name: Build and Release

on:
  push:
    branches:
      - 'master'
    paths:
      - 'pom.xml'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      MAVEN_OPTS: "-Dmaven.repo.local=./.m2/repository"
      RELEASE_TAG: "Unknown"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Extract version from pom.xml
      id: extract-version
      run: echo "::set-output name=version::$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)"

    - name: Set RELEASE_TAG in env
      run: echo "RELEASE_TAG=${{ steps.extract-version.outputs.version }}" >> $GITHUB_ENV

    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        distribution: corretto
        java-version: 8

    - name: Build with Maven
      run: mvn -B package --file pom.xml

    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: DecentHolograms-${{ env.RELEASE_TAG }}
        path: decent-holograms-plugin/target/DecentHolograms-${{ env.RELEASE_TAG }}.jar

    - name: Start Spigot Server
      run: |
        curl -o spigot.jar https://cdn.getbukkit.org/spigot/spigot-1.16.5.jar
        java -jar spigot.jar
    
    - name: Accept EULA
      run: |
        echo "eula=true" > eula.txt
        pwd
    
    - name: Download artifact to plugins folder
      uses: actions/download-artifact@v2
      with:
        name: DecentHolograms-${{ env.RELEASE_TAG }}
        path: plugins/DecentHolograms-${{ env.RELEASE_TAG }}.jar

    - name: Execute Minecraft Commands
      run: |
        screen -S minecraft -d -m java -Xmx2G -jar spigot.jar nogui
        sleep 5
        screen -r minecraft -X stuff "dh$(printf \\r)"
        screen -r minecraft -X stuff "dh test$(printf \\r)"
        screen -r minecraft -X stuff "stop$(printf \\r)"
        while pgrep -u root -f "java -Xmx2G -jar spigot.jar nogui" > /dev/null; do sleep 1; done
    
    - name: Create Github release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        release_name: DecentHolograms ${{ env.RELEASE_TAG }}
        draft: false
        prerelease: false
